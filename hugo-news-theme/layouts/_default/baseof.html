<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}" dir="rtl">

<head>
    {{ partial "head.html" . }}
</head>

<body>
    {{ partial "header.html" . }}

    <main class="flex-1">
        {{ block "main" . }}{{ end }}
    </main>

    {{ partial "footer.html" . }}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tocDesktop = document.querySelector('.toc-desktop');
            const tocSticky = document.querySelector('.toc-sticky');
            const tocStickyHeader = document.querySelector('.toc-sticky-header');
            const tocStickyContent = document.querySelector('.toc-sticky-content');
            
            if (!tocDesktop || !tocSticky) return;
            
            // Calculate trigger point once - based on the bottom of toc-desktop
            const tocDesktopRect = tocDesktop.getBoundingClientRect();
            const triggerPoint = window.scrollY + tocDesktopRect.bottom;
            
            let isSticky = false;
            let ticking = false;
            
            // Scroll event with throttling to prevent flickering
            function updateTocVisibility() {
                const shouldBeSticky = window.scrollY > triggerPoint;
                
                // Only update if state actually changed
                if (shouldBeSticky !== isSticky) {
                    isSticky = shouldBeSticky;
                    
                    if (isSticky) {
                        // Use visibility instead of display to preserve layout
                        tocDesktop.style.visibility = 'hidden';
                        tocDesktop.style.opacity = '0';
                        tocSticky.classList.remove('hidden');
                    } else {
                        tocDesktop.style.visibility = 'visible';
                        tocDesktop.style.opacity = '1';
                        tocSticky.classList.add('hidden');
                    }
                }
                ticking = false;
            }
            
            window.addEventListener('scroll', () => {
                if (!ticking) {
                    requestAnimationFrame(updateTocVisibility);
                    ticking = true;
                }
            });
            
            // Initial check
            updateTocVisibility();
            
            // Hover event for sticky TOC
            if (tocStickyHeader) {
                tocStickyHeader.addEventListener('mouseenter', () => {
                    tocStickyContent.classList.remove('hidden');
                });
            }
            
            if (tocSticky) {
                tocSticky.addEventListener('mouseleave', () => {
                    tocStickyContent.classList.add('hidden');
                });
            }
        });
    </script>
</body>

</html>